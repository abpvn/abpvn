name: Build filter

on:
  workflow_dispatch:
    inputs:
      FORCE_BUILD:
        description: Force filter build
        type: boolean
        default: false
  schedule:
    - cron: 0 */3 * * *

env:
  NEED_BUILD_MASTER: ${{inputs.FORCE_BUILD || false}}
  NEED_BUILD_SINGLE: ${{inputs.FORCE_BUILD || false}}

jobs:
  build_filter_master:
    runs-on: ubuntu-latest
    outputs:
      NEED_BUILD_MASTER: ${{steps.check_build.outputs.NEED_BUILD_MASTER}}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: master
      - name: Check need to build
        id: check_build
        if: ${{ env.NEED_BUILD_MASTER == 'false'}}
        working-directory: ./filter
        run: |
          bash build.sh
          DIFF_STAT=$(git diff --stat abpvn_ublock.txt)
          echo $DIFF_STAT
          if [[ "$DIFF_STAT" != *"| 6 +++---"* ]]; then
            echo "Need build to update to latest version"
            echo "NEED_BUILD_MASTER=yes" >> $GITHUB_ENV
          else
            echo "Nothing to build"
          fi
          git checkout .
          echo "NEED_BUILD_MASTER=$NEED_BUILD_MASTER" >> $GITHUB_OUTPUT
      - name: Build filter
        if: ${{ env.NEED_BUILD_MASTER == 'yes' }}
        run: |
          BRANCH=${GITHUB_REF##*/}
          git config user.name github-actions
          git config user.email github-actions@github.com
          BUILD_OUTPUT=$(bash commit.sh true)
          DEL_VERSIONS=""
          [[ ${BUILD_OUTPUT} =~ "These tag should be delete manualy: '(.*)'" ]] && \
            DEL_VERSIONS=${BASH_REMATCH[1]}
          echo "Version to delete: $DEL_VERSIONS"
          if [ "$DEL_VERSION" != "" ]; then
            git push -d origin $DEL_VERSION
          fi
          GIT_TAG=$(cat version)
          git commit -m "Auto build filter on $BRANCH to $GIT_TAG"
          git push origin $BRANCH
          git tag $GIT_TAG
          git push origin $GIT_TAG
  build_filter_single:
    runs-on: ubuntu-latest
    outputs:
      NEED_BUILD_SINGlE: ${{steps.check_build.outputs.NEED_BUILD_SINGlE}}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: single
      - name: Check need to build
        id: check_build
        if: ${{ env.NEED_BUILD_SINGLE == 'false'}}
        working-directory: ./filter
        run: |
          bash build.sh
          DIFF_STAT=$(git diff --stat abpvn_ublock.txt)
          echo $DIFF_STAT
          if [[ "$DIFF_STAT" != *"| 6 +++---"* ]]; then
            echo "Need build to update to latest version"
            echo "NEED_BUILD_SINGLE=yes" >> $GITHUB_ENV
          else
            echo "Nothing to build"
          fi
          git checkout .
          echo "NEED_BUILD_SINGLE=$NEED_BUILD_SINGLE" >> $GITHUB_OUTPUT
      - name: Build filter
        if: ${{ env.NEED_BUILD_SINGLE == 'yes' }}
        run: |
          BRANCH=${GITHUB_REF##*/}
          git config user.name github-actions
          git config user.email github-actions@github.com
          BUILD_OUTPUT=$(bash commit.sh true)
          DEL_VERSIONS=""
          [[ ${BUILD_OUTPUT} =~ "These tag should be delete manualy: '(.*)'" ]] && \
            DEL_VERSIONS=${BASH_REMATCH[1]}
          echo "Version to delete: $DEL_VERSIONS"
          if [ "$DEL_VERSION" != "" ]; then
            git push -d origin $DEL_VERSION
          fi
          GIT_TAG=$(cat version)
          git commit -m "Auto build filter on $BRANCH to $GIT_TAG"
          git push origin $BRANCH
          git tag $GIT_TAG
          git push origin $GIT_TAG
  update_server_filter:
    runs-on: ubuntu-latest
    needs: [build_filter_master, build_filter_single]
    if: ${{ needs.build_filter_master.outputs.NEED_BUILD_MASTER == 'yes' || needs.build_filter_single.outputs.NEED_BUILD_SINGLE == 'yes' }}
    steps:
      - uses: actions/checkout@v4
      - name: Request to server
        run: bash pull.sh